# Trips

Сайт для автоматизации рутинных процессов туристического агенства.

## Первая настройка и запуск сайта из среды PyCharm под Windows

* Устанавливаем Python 3.9

* После открытия проекта создаём новый интерпретатор Python c новым "virtualenv environment", 
  см. инструкцию тут: <https://www.jetbrains.com/help/pycharm/configuring-python-interpreter.html#add_new_project_interpreter>

* Устанавливаем зависимости: <https://www.jetbrains.com/help/pycharm/managing-dependencies.html#apply_dependencies>

* Если в папке trips (рядом с файлом manage.py) отсутствует конфигурационный файл .env,
  то создаём его.

  > _**ДЛЯ ЧЕГО НУЖЕН ФАЙЛ .ENV**_
  > 
  > В этом файле хранятся секретный ключ и другие чувствительные данные,
  > такие как пароли к БД - на локальных компьютерах они могут отличаться 
  > (а на сервере они обязательно должны быть уникальны). 
  > 
  > На сервере к этому файлику должен быть доступ только у владельца. 
  > Этого можно добиться командой `chmod 0600 .env`.
  > 
  > Сгенерировать уникальный ключ можно командой в Python Console:
  > 
  > ```bash
  > python manage.py shell
  > >>> import django.core.management.utils
  > >>> django.core.management.utils.get_random_secret_key()
  > >>> exit()
  > ```

  На локальной машине файл должен содержать строку вида SECRET_KEY='???', 
  где вместо ??? нужно указать уникальный секретный ключ (одинарные кавычки обязательны, 
  иначе из-за спецсимволов типа '#' ключ прочитается неправильно). 

* Если отсутствует база данных db.sqlite3, то нужно её создать. Для этого в терминале вводим команду:
  ```bash
  python manage.py migrate
  ```

  Затем создаём суперпользователя (адрес электронной почты указывать необязательно):
  
  ```bash
  python manage.py createsuperuser
  ```

  И применяем вспомогательные fixtures-ы для заполнения БД тестовыми данными, 
  см. инструкцию [fixtures.md](./trips/doc/fixtures.md)

* Запускать сайт можно с помощью конфигурации запуска **_trips_**.
  Подробнее про конфигурации запуска см. тут: <https://www.jetbrains.com/help/pycharm/run-debug-configuration.html>

## Создание новой конфигурации запуска

При создании своей конфигурации запуска нужно не забыть указать, какой файл настроек использовать.
Для этого надо в настройках конфигурации задать переменную среды `DJANGO_SETTINGS_MODULE`, например: 
`DJANGO_SETTINGS_MODULE=trips.settings.development_win64` (это настройки для отладки под Windows x64).

Если забыть задать переменную `DJANGO_SETTINGS_MODULE`, сайт запускаться не будет.

## Настройки в админке

На странице _**/admin**_ настраиваются пользователи сайта и их права (внизу страницы), а также:
* Настройки агентств (таблица Агентства): кабинеты контрагентов, ID в Яндекс метрике и другие
* Реквизиты банков (таблица Банки)
* Аватары пользователей (таблица Аватары сотрудников)
* Аккаунты агентств в соц. сетях (таблица называется так же)
* Ключи доступа к платёжным системам (для доступа к ЮKassa; таблица называется так же)
* Места сбора групп (таблица называется так же)

## Обновление версии на сервере (на примере сайта адат.тур-бизнес.рф)

Выкладываем новую версию в папку _**/home/site/adat/automation/**_

> _**ВНИМАНИЕ**_
>
> При обновлении содержимого папки следует соблюдать осторожность, чтобы
> не перетереть содержимое файлика .env, а также папки log и т.п.

После этого запускаем команды:

```bash
cd /home/site/adat/automation

source ../venv/bin/activate
export DJANGO_SETTINGS_MODULE=trips.settings.adat_new
pip install -r requirements.txt
python trips/manage.py collectstatic --noinput

# Делаем бэкап перед обновлением базы данных
./lib/backup/pg_backup.sh

python trips/manage.py migrate

# Обновляем группы пользователей и данные по банкам
python trips/manage.py loaddata trips/main/fixtures/user_groups.json
python trips/manage.py loaddata trips/main/fixtures/bank_details.json

sudo systemctl restart adat.daphne
```

## Особенности используемых библиотек

### Библиотека python-pdf (pydf)

Эта библиотека использует инструмент wkhtmltopdf для генерации PDF из HTML. 
Но в пакет включена только сборка wkhtmltopdf под линукс.
Поэтому для запуска под Windows приходится exe-шник хранить в нашем проекте (см. в папке [trips/bin](./trips/bin/)), а в настройках django задавать специальную переменную окружения, см. настройки development_win64.py.

### Библиотека Pillow

Используется у нас для обработки и валидации картинок. 
Также нужна, чтобы openpyxl не "терял" картинки в загружаемых excel-шаблонах.

### Библиотека django-cryptography

Используется для шифрования ключей доступа к платёжным системам. Ключ шифрования берётся из конфигурационного файла.
При необходимости изменить ключ шифрования нужно написать хитрую миграцию или скрипт 
(см. https://django-cryptography.readthedocs.io/en/latest/migrating.html).

## Полезные ссылки

* Fixtures в нашем проекте и как ими пользоваться: [fixtures.md](./trips/doc/fixtures.md)
* Группы пользователей и их права: [Права пользователей.docx](./trips/doc/Права пользователей.docx)
